{% extends 'base.html' %}

{% block content %}
<div class="grades-container">
    <h2>Manage Grades</h2>
    <div class="user-selection">
        <select id="userSelect" class="user-select">
            <option value="">Select a user</option>
            {% for user in users %}
                {% if user.role == 'user' %}
                    <option value="{{ user.userid }}">{{ user.name }} ({{ user.email }})</option>
                {% endif %}
            {% endfor %}
        </select>
    </div>
    <div class="grade-form">
        <form action="{{ url_for('manage_grades') }}" method="post" id="gradeForm">
            <input type="hidden" name="userid" id="userIdInput">
            <div class="form-message">{{ msg }}</div>
            <div class="form-group">
                <label for="subject">Subject</label>
                <input type="text" name="subject" id="subject" placeholder="Enter subject name" required>
            </div>
            <div class="form-group">
                <label for="grade">Grade</label>
                <input type="text" name="grade" id="grade" placeholder="Enter grade (A, B, C, etc.)" required>
            </div>
            <div class="form-group">
                <label for="score">Score</label>
                <input type="number" name="score" id="score" min="0" max="100" placeholder="Enter score (0-100)" required>
            </div>
            <div class="form-group">
                <label for="comments">Comments</label>
                <textarea name="comments" id="comments" rows="3" placeholder="Enter comments"></textarea>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Save Grade</button>
            </div>
        </form>
    </div>
    <div class="user-grades" id="userGrades">
        <h3>User Grades</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Grade</th>
                        <th>Score</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gradesTableBody">
                    <!-- Grades will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSelect = document.getElementById('userSelect');
    const userIdInput = document.getElementById('userIdInput');
    const gradesTableBody = document.getElementById('gradesTableBody');
    const userGrades = document.getElementById('userGrades');
    
    userGrades.style.display = 'none';
    
    userSelect.addEventListener('change', function() {
        const userId = this.value;
        userIdInput.value = userId;
        
        if (userId) {
            // In a real application, you would fetch grades from the server
            // For this template, we'll just show/hide the grades section
            userGrades.style.display = 'block';
            
            // Clear previous grades
            gradesTableBody.innerHTML = '';
            
            // In a real application, you would populate this with actual data
            // This is just a placeholder
            const placeholderRow = document.createElement('tr');
            placeholderRow.innerHTML = `
                <td colspan="5">Select a user to view their grades</td>
            `;
            gradesTableBody.appendChild(placeholderRow);
        } else {
            userGrades.style.display = 'none';
        }
    });
});

userSelect.addEventListener('change', function() {
    const userId = this.value;
    userIdInput.value = userId;
    
    if (userId) {
        // Fetch the user's grades from the server
        fetch(`/get_user_grades/${userId}`)
            .then(response => response.json())
            .then(grades => {
                userGrades.style.display = 'block';
                
                // Clear previous grades
                gradesTableBody.innerHTML = '';
                
                if (grades.length > 0) {
                    // Populate table with grades
                    grades.forEach(grade => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${grade.subject}</td>
                            <td>${grade.grade}</td>
                            <td>${grade.score}</td>
                            <td>${new Date(grade.grade_date).toLocaleDateString()}</td>
                            <td class="actions">
                                <a href="#" class="btn btn-danger btn-sm" onclick="deleteGrade(${grade.grade_id})">
                                    <i class="fas fa-trash"></i> Delete
                                </a>
                            </td>
                        `;
                        gradesTableBody.appendChild(row);
                    });
                } else {
                    // Show empty state
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" class="text-center">No grades found for this student</td>
                    `;
                    gradesTableBody.appendChild(row);
                }
            });
    } else {
        userGrades.style.display = 'none';
    }
});

function deleteGrade(gradeId) {
    if (confirm('Are you sure you want to delete this grade?')) {
        // In a real app, this would send an AJAX request to delete the grade
        // For now, we'll just reload the page
        alert('Grade deletion would happen here');
    }
    return false;
};
</script>
{% endblock %}